on:
  workflow_call:
    inputs:
      # Whether to move the source_folder/source_site_files_folder/* to source_folder/
      move_site_files:
        default: 'false'
        required: false
        type: string
      # The folder to deploy from WITH a / at the end
      source_folder:
        default: _site/
        required: false
        type: string
      # The location of the site files WITH a / at the end
      source_site_files_folder:
        default: site_files/
        required: false
        type: string
      # The branch to deploy to
      target_branch:
        default: pages
        required: false
        type: string
      # Whether to deploy to an external repository or not
      target_external_repository:
        default: 'false'
        required: false
        type: string
      # The repository to deploy to IF not the same repository
      target_repository_name:
        required: false
        type: string
    secrets:
      # This should be set in the GitHub repository settings IF deploying to external repository
      private_deploy_key:
        required: false

jobs:
  main:
    if: github.REF == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2147483647
          ref: main

      - name: Install Ruby and Bundle Install
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Jekyll Build
        run: JEKYLL_ENV=production bundle exec jekyll build --destination ${{ inputs.source_folder }}

      - if: ${{ inputs.move_site_files == 'true' }}
        name: Move Site Files
        uses: emmahsax/reusable-github-actions-workflows/move-up-nested-files@test
        with:
          dir: ${{ inputs.source_folder }}
          nested_dir: ${{ inputs.source_site_files_folder }}

      - if: ${{ inputs.target_external_repository == 'true' }}
        name: Deploy Site to External Repository
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: ${{ inputs.target_branch }}
          clean: true
          commit-message: Deploy to ${{ inputs.target_repository_name }}
          folder: ${{ inputs.source_folder }}
          git-config-email: 41898282+github-actions[bot]@users.noreply.github.com
          git-config-name: github-actions[bot]
          repository-name: ${{ inputs.target_repository_name }}
          silent: true
          ssh-key: ${{ secrets.private_deploy_key }}

      - if: ${{ inputs.target_external_repository == 'false' }}
        name: Deploy Site to Internal Branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: ${{ inputs.target_branch }}
          clean: true
          commit-message: Deploy to ${{ github.repository }}
          folder: ${{ inputs.source_folder }}
          git-config-email: 41898282+github-actions[bot]@users.noreply.github.com
          git-config-name: github-actions[bot]
          silent: true
